var pizzaDetails = [
//     {
//         id: "cp1",
//         name: "Chicken Pepperoni Pizza",
//         price: 480,
//         image: "./images/chicken-pepperoni-pizza.jpeg",
//         qty: 1
//     },
//     {
//         id: "cp2",
//         name: "Chicken Sausage Pizza",
//         price: 239,
//         image: "./images/chicken-sausage-pizza.jpeg",
//         qty: 1
//     },
//     {
//         id: "cp3",
//         name: "Grilled Chicken & Peppers Pizza",
//         price: 315,
//         image: "./images/grilled-chicken-peppers-pizza.jpeg",
//         qty: 1
//     },
//     {
//         id: "cp4",
//         name: "Spicy Chicken Barbeque Pizza",
//         price: 359,
//         image: "./images/spicy-chicken-barbeque-pizza.jpeg",
//         qty: 1
//     },
//     {
//         id: "cp5",
//         name: "Spicy Chicken Tandoori Pizza",
//         price: 465,
//         image: "./images/spicy-chicken-tandoori-pizza.jpeg",
//         qty: 1
//     },
//     {
//         id: "cp6",
//         name: "Chicken Supreme Pizza",
//         price: 480,
//         image: "./images/chicken-supreme-pizza.jpeg",
//         qty: 1
//     },
//     {
//         id: "cp7",
//         name: "Chicken Cafreal & Onions Pizza",
//         price: 355,
//         image: "./images/chicken-cafreal-onions-pizza.jpeg",
//         qty: 1
//     },
//     {
//         id: "vp1",
//         name: "Double Cheese Margarita Pizza",
//         price: 265,
//         image: "./images/double-cheese-margarita-pizza.jpeg",
//         qty: 1
//     },
//     {
//         id: "vp2",
//         name: "Spicy Mushroom Peppers Pizza",
//         price: 265,
//         image: "./images/spicy-mushroom-peppers-pizza.jpeg",
//         qty: 1
//     },
//     {
//         id: "vp3",
//         name: "Veg Margarita Pizza",
//         price: 189,
//         image: "./images/veg-margarita-pizza.jpeg",
//         qty: 1
//     },
//     {
//         id: "vp4",
//         name: "Spicy Tandoori Paneer Pizza",
//         price: 399,
//         image: "./images/spicy-tandoori-paneer-pizza.jpeg",
//         qty: 1
//     },
//     {
//         id: "vp5",
//         name: "Tomato Fresh Veggie Pizza",
//         price: 265,
//         image: "./images/tomato-fresh-veggie-pizza.jpeg",
//         qty: 1
//     },
//     {
//         id: "vp6",
//         name: "Premium Veggie Pizza",
//         price: 399,
//         image: "./images/premium-veggie-pizza.jpg",
//         qty: 1
//     },
//     // {
//     //     name: "Chicken Pepperoni Pizza",
//     //     price: 480,
//     //     image: "./images/chicken-pepperoni-pizza.jpeg"
//     // },
//     // {
//     //     name: "Chicken Pepperoni Pizza",
//     //     price: 480,
//     //     image: "./images/chicken-pepperoni-pizza.jpeg"
//     // },
//     // {
//     //     name: "Chicken Pepperoni Pizza",
//     //     price: 480,
//     //     image: "./images/chicken-pepperoni-pizza.jpeg"
//     // },
//     // {
//     //     name: "Chicken Pepperoni Pizza",
//     //     price: 480,
//     //     image: "./images/chicken-pepperoni-pizza.jpeg"
//     // },
//     // {
//     //     name: "Chicken Pepperoni Pizza",
//     //     price: 480,
//     //     image: "./images/chicken-pepperoni-pizza.jpeg"
//     // },
//     // {
//     //     name: "Chicken Pepperoni Pizza",
//     //     price: 480,
//     //     image: "./images/chicken-pepperoni-pizza.jpeg"
//     // },
//     // {
//     //     name: "Chicken Pepperoni Pizza",
//     //     price: 480,
//     //     image: "./images/chicken-pepperoni-pizza.jpeg"
//     // },
]

var drinkDetails = [
    // {
    //     id: "d1",
    //     name: "Classic Lemonade",
    //     price: 120,
    //     image: "./images/classic-lemonade.jpg",
    //     qty: 1
    // },
    // {
    //     id: "d2",
    //     name: "Lemon Iced Tea",
    //     price: 120,
    //     image: "./images/lemon-iced-tea.jpg",
    //     qty: 1
    // },
    // {
    //     id: "d3",
    //     name: "Masala Lemonade",
    //     price: 135,
    //     image: "./images/masala-lemonade.jpg",
    //     qty: 1
    // },
    // {
    //     id: "d4",
    //     name: "Cocoa Frappe",
    //     price: 215,
    //     image: "./images/cocoa-frappe.jpg",
    //     qty: 1
    // },
    // {
    //     id: "d5",
    //     name: "Coffee Frappe",
    //     price: 215,
    //     image: "./images/coffee-frappe.jpg",
    //     qty: 1
    // },
    // {
    //     id: "d6",
    //     name: "Mango Frappe",
    //     price: 215,
    //     image: "./images/mango-frappe.jpg",
    //     qty: 1
    // },
    // {
    //     id: "d7",
    //     name: "Strawberry Frappe",
    //     price: 215,
    //     image: "./images/strawberry-frappe.jpg",
    //     qty: 1
    // },
    // {
    //     id: "d8",
    //     name: "Vanilla Frappe",
    //     price: 190,
    //     image: "./images/vanilla-frappe.jpg",
    //     qty: 1
    // },
    // {
    //     id: "d9",
    //     name: "Lemon Grass Iced Tea",
    //     price: 195,
    //     image: "./images/lemon-grass-iced-tea.jpeg",
    //     qty: 1
    // },
    // // {
    // //     id: "vp4",
    // //     name: "Spicy Tandoori Paneer Pizza",
    // //     price: 399,
    // //     image: "./images/spicy-tandoori-paneer-pizza.jpeg",
    // //     qty: 1
    // // },
    // // {
    // //     id: "vp5",
    // //     name: "Tomato Fresh Veggie Pizza",
    // //     price: 265,
    // //     image: "./images/tomato-fresh-veggie-pizza.jpeg",
    // //     qty: 1
    // // },
    // // {
    // //     id: "vp6",
    // //     name: "Premium Veggie Pizza",
    // //     price: 399,
    // //     image: "./images/premium-veggie-pizza.jpeg",
    // //     qty: 1
    // // },
    // // {
    // //     name: "Chicken Pepperoni Pizza",
    // //     price: 480,
    // //     image: "./images/chicken-pepperoni-pizza.jpeg"
    // // },
    // // {
    // //     name: "Chicken Pepperoni Pizza",
    // //     price: 480,
    // //     image: "./images/chicken-pepperoni-pizza.jpeg"
    // // },
    // // {
    // //     name: "Chicken Pepperoni Pizza",
    // //     price: 480,
    // //     image: "./images/chicken-pepperoni-pizza.jpeg"
    // // },
    // // {
    // //     name: "Chicken Pepperoni Pizza",
    // //     price: 480,
    // //     image: "./images/chicken-pepperoni-pizza.jpeg"
    // // },
    // // {
    // //     name: "Chicken Pepperoni Pizza",
    // //     price: 480,
    // //     image: "./images/chicken-pepperoni-pizza.jpeg"
    // // },
    // // {
    // //     name: "Chicken Pepperoni Pizza",
    // //     price: 480,
    // //     image: "./images/chicken-pepperoni-pizza.jpeg"
    // // },
    // // {
    // //     name: "Chicken Pepperoni Pizza",
    // //     price: 480,
    // //     image: "./images/chicken-pepperoni-pizza.jpeg"
    // // },
    // // {
    // //     name: "Chicken Pepperoni Pizza",
    // //     price: 480,
    // //     image: "./images/chicken-pepperoni-pizza.jpeg"
    // // },
]


$('#cart').click(function() {
    $('.cart-outer').css("top", "0%");
    $(document).on('keydown', function(event) {
        if (event.key == "Escape") {
            closeCart();
        }
    });
})

function closeCart() {
    $('.cart-outer').css("top", "-150%");
}

function getCookie(cookieName) {
    var name = cookieName + "=";
    var ca = document.cookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i].trim();
        if ((c.indexOf(name)) == 0) {
            return c.substr(name.length);
        }
    }
}

var cart = []

var cartItemsCount = 0;

var cartItems = "";

var totalPrice = 0;

// pizzaDetails = tempPizzaDetails;
// drinkDetails = tempDrinkDetails;

// pizzaDetails = tempPizzaDetails;
// drinkDetails = tempDrinkDetails;

function createCartList() {

    if (cart.length == 0) {
        cartItems += "<div class='empty-cart'><h5>Your Cart is <span style='color: var(--primary)'>Empty</span></h5></div>";
    } 
    else {
        cartItems = "";
        totalPrice = 0;
        $.each(cart, function(i, item) {
            //console.log(item.id)
            cartItems += `<div class='cart-item'><img src= '${item.image}' height='150px' width='150px' style='border-radius: 20px;max-width: 150px'><h6>${item.name}</h6><h6 style='color: #000'><span style='color: var(--secondary);font-weight: 600' id='${item.id}-total-price'>₹${item.price * item.qty}</span></h6><input type='number' value='${item.qty}' onchange='updateCart("${item.price}", this.value, "${item.id}")'><button onclick='removeFromCart("${item.id}")'><i class='bi bi-trash3'></i></button></div>`;
            totalPrice += item.price * item.qty;
            $("#" + item.id).html("<i class='bi bi-cart-check'></i>");
            //$("#" + item.id).click(removeFromCart());
        })
    }

    //console.log(cartItems, totalPrice);
    $('#total-price').html("₹" + totalPrice);
    $('#cart-list').html(cartItems);
}

if (sessionStatus == 'inactive') {
    try {
        result = JSON.parse(getCookie('cartItems'));
        cart = result;
        cartItemsCount = cart.length;
        createCartList();
    }
    catch(err) {
        if (err) {
            set_cookie("cartItems", cart, 24);
            //console.log("cart created");
        }
    }
}
else {
    cart = tempCart;
    cartItemsCount = cart.length;
    createCartList();
}

function set_cookie(cookiename, cookievalue, hours) {
    var date = new Date();
    date.setTime(date.getTime() + Number(hours) * 3600 * 1000);
    document.cookie = cookiename + "=" + JSON.stringify(cookievalue) + "; path=/;SameSite=Strict;expires = " + date.toGMTString();
}

function updateDb(_id, action, type) {
    // if (action == "add") {
        // alert("dbupdated");
        var itemQty;
        var item = cart.find(obj => obj.id === _id);
        if (item != undefined) {
            itemQty = item.qty;
        }
        // $.each(cart, function(i, item) {
        //     if (_id == item.id) {
        //         itemQty = item.qty;
        //     }
        // })
        // alert(action, _id)
        $.post('/brotherspizza/updateCart.php', {id: _id, qty: itemQty, act: action, type: type});
    // }
}

function clearClass() {
    $('#added-to-cart').removeClass('added-to-cart');
}


function addToCart(_id) {
    // var type;
    // var repeated = false;
    console.log();
    var pizza = pizzaDetails.find(obj => obj.id === _id);
    if (pizza != undefined) {
        if (cart.find(obj => obj.id === _id) == undefined) {
            cart.push(pizza);
            cartItemsCount++;
            $("#" + pizza.id).html("<i class='bi bi-cart-check'></i>");
            $('#addToCartButton').attr("onclick", `removeFromCart('${_id}')`);
            $("#addToCartButton").html("<i class='bi bi-trash3' style='margin-right: 10px'></i>Remove from Cart");
            $('#added-to-cart').addClass('added-to-cart');
            setTimeout(clearClass, 2000);
            //alert(pizza.type);
            // type = 'pizza';
            if(sessionStatus == 'active') {
                updateDb(_id, "add", pizza.type);
            }
        }
        createCartList();
    }

    var drink = drinkDetails.find(obj => obj.id === _id);
    //alert(_id);
    if (drink != undefined) {
        if (cart.find(obj => obj.id === _id) == undefined) {
            cart.push(drink);
            cartItemsCount++;
            $("#" + drink.id).html("<i class='bi bi-cart-check'></i>");
            $('#addToCartButton').attr("onclick", `removeFromCart('${_id}')`);
            $("#addToCartButton").html("<i class='bi bi-trash3' style='margin-right: 10px'></i>Remove from Cart");
            $('#added-to-cart').addClass('added-to-cart');
            setTimeout(clearClass, 2000);
            //alert(drink.type);
            // type = 'pizza';
            if(sessionStatus == 'active') {
                updateDb(_id, "add", drink.type);
            }
        }
        createCartList();
    }

    // $.each(pizzaDetails, function(i, pizza) {
    //     //alert(pizza);
    //     if (_id == pizza.id) {

    //         //console.log(!cart.includes(pizza));
    //         if (cart.length > 0 ) {
    //             $.each(cart, function(i, item) {
    //                 if(item.id == _id) {
    //                     repeated = true;
    //                 }
    //                 if (!repeated) {
    //                     cart.push(pizzaDetails[i]);
    //                     cartItemsCount++;
    //                     $("#" + pizza.id).html("<i class='bi bi-cart-check'></i>");
    //                     type = 'pizza';
    //                     if(sessionStatus == 'active') {
    //                         updateDb(_id, "add", type);
    //                     }
    //                 }
    //             });
    //         }
    //         else {
    //             cart.push(pizzaDetails[i]);
    //             cartItemsCount++;
    //             $("#" + pizza.id).html("<i class='bi bi-cart-check'></i>");
    //             type = 'pizza';
    //             if(sessionStatus == 'active') {
    //                 updateDb(_id, "add", type);
    //             }
    //         }
    //         createCartList();
    //     }
    // })

    // $.each(drinkDetails, function(i, drink) {
    //     if (_id == drink.id) {
    //         $.each(cart, function(i, item) {
    //             if(item.id != _id) {
    //                 cart.push(drinkDetails[i]);
    //                 cartItemsCount++; 
    //                 $("#" + drink.id).html("<i class='bi bi-cart-check'></i>"); 
    //                 type = 'drink';
    //                 if(sessionStatus == 'active') {
    //                     updateDb(_id, "add", type);
    //                 }
    //             } 
    //         });
    //         createCartList();
    //     }
    // })

    if (cartItemsCount > 0) {
        $("#cart-notification").css("display", "flex");
        $("#cart-notification").html(cartItemsCount);
    }

    if (sessionStatus == 'inactive') {
        set_cookie("cartItems", cart, 24);
    }
}

async function removeFromCart(_id) {
    var type;
    await $.each(cart, function(i, item) {
        console.log(item);
        if (_id == item.id) {
            cart.splice(i, 1);
            cartItemsCount--;
            type = item.type;
        }
        totalPrice = 0;
        cartItems = "";
        createCartList();
        $('#cart-list').html(cartItems);
        $("#" + item.id).html("<i class='bi bi-cart-plus'>");
        $('#addToCartButton').attr("onclick", `addToCart('${_id}')`);
        $("#addToCartButton").html("<i class='bi bi-cart-plus' style='margin-right: 10px'></i>Add to Cart");

        if (cartItemsCount > 0) {
            $("#cart-notification").html(cartItemsCount);
        }
        else {
            $("#cart-notification").css("display", "none");
        }

        if (sessionStatus == 'inactive') {
            set_cookie("cartItems", cart, 24);
        }
        else {
            //console.log(cart);
            updateDb(_id, "remove", type);
        }
    })

}

if (cartItemsCount > 0) {
    $("#cart-notification").css("display", "flex");
    $("#cart-notification").html(cartItemsCount);
}

function updateCart(price, value, _id) {
    var type;
    //console.log(price * value, _id);
    $('#' + _id + '-total-price').html('₹' + price * value);
    var item = cart.find(i => i.id === _id);
    console.log(item.id);
    type = item.type;
    cart[cart.indexOf(item)].qty = value;
    if (sessionStatus == 'inactive') {
        set_cookie("cartItems", cart, 24);
    }
    else {
        //console.log(cart);
        updateDb(_id, "update", type);
    }
    totalPrice = 0;
    $.each(cart, function(i, item) {
        totalPrice += item.price * item.qty;
    })
    $('#total-price').html("₹" + totalPrice);
}